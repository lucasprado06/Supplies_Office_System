{% extends 'base.html' %}

{% block title %}Fazer Requisição{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white text-center">
            <h2 class="h5 mb-0">Fazer Requisição de Materiais</h2>
        </div>
        <div class="card-body">
            <form action="{{ url_for('enviar_requisicao') }}" method="post" id="requisicao-form">
                <div class="form-row mb-4">
                    <div class="col-md-6 form-group">
                        <label>Solicitante:</label>
                        <input type="text" class="form-control" value="{{ session['user']['nome'] }}" readonly>
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Departamento:</label>
                        <input type="text" class="form-control" value="{{ session['user']['departamento'] }}" readonly>
                    </div>
                </div>

                <hr>

                <h3 class="h6 mb-3">Adicionar Item</h3>

                <div class="form-row align-items-end mb-3">
                    <div class="col-md-6 form-group">
                        <label for="material-datalist">Buscar material</label>
                        <input class="form-control" list="materials-options" id="material-datalist" placeholder="Digite o código ou a descrição...">
                        <datalist id="materials-options">
                            {% for material in materiais %}
                                <option value="{{ material.codigo }} - {{ material.descricao }}" data-codigo="{{ material.codigo }}" data-descricao="{{ material.descricao }}" data-quantidade="{{ material.quantidade_maxima }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="col-md-3 form-group">
                        <label for="quantidade">Quantidade</label>
                        <input type="number" class="form-control" id="quantidade" min="1" value="1">
                    </div>
                    <div class="col-md-3 form-group">
                        <button type="button" class="btn btn-secondary btn-block" id="add-item-btn">Adicionar</button>
                    </div>
                </div>

                <hr>

                <h3 class="h6 mb-3">Itens da Requisição</h3>
                <div id="requisition-items">
                    </div>
                
                <p id="no-items-message" class="text-center text-muted">Nenhum item adicionado ainda.</p>

                <div class="text-right mt-4">
                    <button type="submit" class="btn btn-primary">Enviar Requisição</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var addItemBtn = document.getElementById('add-item-btn');
        var materialDatalist = document.getElementById('material-datalist');
        var quantidadeInput = document.getElementById('quantidade');
        var requisitionItemsDiv = document.getElementById('requisition-items');
        var noItemsMessage = document.getElementById('no-items-message');
        var itemCounter = 0;

        // Atualiza a mensagem "Nenhum item adicionado"
        function updateNoItemsMessage() {
            if (requisitionItemsDiv.children.length > 0) {
                noItemsMessage.style.display = 'none';
            } else {
                noItemsMessage.style.display = 'block';
            }
        }

        // Adiciona um novo item ao formulário
        addItemBtn.addEventListener('click', function() {
            var selectedValue = materialDatalist.value;
            var selectedOption = document.querySelector('#materials-options option[value="' + selectedValue + '"]');

            if (!selectedOption) {
                alert('Por favor, selecione um material válido da lista.');
                return;
            }

            var codigo = selectedOption.getAttribute('data-codigo');
            var descricao = selectedOption.getAttribute('data-descricao');
            var quantidadeMaxima = parseInt(selectedOption.getAttribute('data-quantidade'));
            var quantidadeSolicitada = parseInt(quantidadeInput.value);

            if (quantidadeSolicitada <= 0 || quantidadeSolicitada > quantidadeMaxima) {
                alert('A quantidade deve ser entre 1 e ' + quantidadeMaxima + '.');
                return;
            }

            var newItem = document.createElement('div');
            newItem.className = 'card mb-2';
            newItem.innerHTML = `
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <input type="hidden" name="materiais[${itemCounter}][codigo]" value="${codigo}">
                            <input type="hidden" name="materiais[${itemCounter}][quantidade]" value="${quantidadeSolicitada}">
                            <p class="mb-0"><strong>${codigo} - ${descricao}</strong></p>
                            <small class="text-muted">Qtd. Solicitada: ${quantidadeSolicitada}</small>
                        </div>
                        <div class="col-4 text-right">
                            <button type="button" class="btn btn-sm btn-danger remove-item-btn">&times;</button>
                        </div>
                    </div>
                </div>
            `;
            requisitionItemsDiv.appendChild(newItem);
            itemCounter++;

            // Reseta os campos de entrada
            materialDatalist.value = '';
            quantidadeInput.value = '1';

            // Adiciona o evento de remoção ao novo botão
            newItem.querySelector('.remove-item-btn').addEventListener('click', function() {
                newItem.remove();
                updateNoItemsMessage();
            });

            updateNoItemsMessage();
        });

        updateNoItemsMessage();
    });
</script>
