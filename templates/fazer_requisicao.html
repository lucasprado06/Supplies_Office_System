{% extends 'base.html' %}

{% block title %}Fazer Requisição{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white text-center">
            <h2 class="h5 mb-0">Fazer Requisição de Materiais</h2>
        </div>
        <div class="card-body">
            <form action="{{ url_for('enviar_requisicao') }}" method="post" id="requisicao-form">
                <div class="form-row mb-4">
                    <div class="col-md-6 form-group">
                        <label>Solicitante:</label>
                        <input type="text" class="form-control" value="{{ session['user']['nome'] }}" readonly>
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Departamento:</label>
                        <input type="text" class="form-control" value="{{ session['user']['departamento'] }}" readonly>
                    </div>
                </div>

                <hr>

                <h3 class="h6 mb-3">Adicionar Item</h3>

                <div class="form-row align-items-end mb-3">
                    <div class="col-md-6 form-group">
                        <label for="material-select">Buscar material</label>
                        <select class="form-control" id="material-select">
                            <option></option>
                            {% for material in materiais %}
                                <option value="{{ material.codigo }}" data-descricao="{{ material.descricao }}" data-quantidade="{{ material.quantidade_maxima }}">
                                    {{ material.codigo }} - {{ material.descricao }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 form-group">
                        <label for="quantidade">Quantidade</label>
                        <input type="number" class="form-control" id="quantidade" min="1">
                    </div>
                    <div class="col-md-3 form-group">
                        <button type="button" class="btn btn-secondary btn-block" id="add-item-btn">Adicionar</button>
                    </div>
                </div>

                <hr>

                <h3 class="h6 mb-3">Itens da Requisição</h3>
                <div id="requisition-items">
                </div>
                
                <p id="no-items-message" class="text-center text-muted">Nenhum item adicionado ainda.</p>

                <div class="text-right mt-4">
                    <button type="submit" class="btn btn-primary" id="enviar-requisicao-btn" disabled>Enviar Requisição</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializa o Select2 na lista suspensa com um novo placeholder
        $('#material-select').select2({
            placeholder: "Digite para pesquisar ou selecione um material",
            allowClear: true // Permite limpar a seleção
        });

        var addItemBtn = document.getElementById('add-item-btn');
        var materialSelect = document.getElementById('material-select');
        var quantidadeInput = document.getElementById('quantidade');
        var requisitionItemsDiv = document.getElementById('requisition-items');
        var noItemsMessage = document.getElementById('no-items-message');
        var enviarRequisicaoBtn = document.getElementById('enviar-requisicao-btn');
        var itemCounter = 0;

        function updateUI() {
            const hasItems = requisitionItemsDiv.children.length > 0;
            noItemsMessage.style.display = hasItems ? 'none' : 'block';
            enviarRequisicaoBtn.disabled = !hasItems;
        }

        addItemBtn.addEventListener('click', function() {
            var selectedOption = materialSelect.options[materialSelect.selectedIndex];
            var quantidadeSolicitada = parseInt(quantidadeInput.value);

            if (!selectedOption || !selectedOption.value) {
                alert('Por favor, selecione um material válido da lista.');
                return;
            }
            
            if (isNaN(quantidadeSolicitada) || quantidadeSolicitada <= 0) {
                alert('Por favor, insira uma quantidade válida.');
                return;
            }

            var codigo = selectedOption.value;
            var descricao = selectedOption.getAttribute('data-descricao');
            var quantidadeMaxima = parseInt(selectedOption.getAttribute('data-quantidade'));

            var existingItems = document.querySelectorAll('input[name^="materiais"][name$="[codigo]"]');
            var itemJaAdicionado = false;
            existingItems.forEach(function(input) {
                if (input.value === codigo) {
                    itemJaAdicionado = true;
                }
            });

            if (itemJaAdicionado) {
                alert('Este material já foi adicionado à requisição.');
                return;
            }

            if (quantidadeSolicitada > quantidadeMaxima) {
                alert(`A quantidade solicitada (${quantidadeSolicitada}) é maior que a quantidade máxima disponível (${quantidadeMaxima}).`);
                return;
            }

            var newItem = document.createElement('div');
            newItem.className = 'card mb-2';
            newItem.innerHTML = `
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <input type="hidden" name="materiais[${itemCounter}][codigo]" value="${codigo}">
                            <input type="hidden" name="materiais[${itemCounter}][quantidade]" value="${quantidadeSolicitada}">
                            <p class="mb-0"><strong>${codigo} - ${descricao}</strong></p>
                            <small class="text-muted">Qtd. Solicitada: ${quantidadeSolicitada}</small>
                        </div>
                        <div class="col-4 text-right">
                            <button type="button" class="btn btn-sm btn-danger remove-item-btn">&times;</button>
                        </div>
                    </div>
                </div>
            `;
            requisitionItemsDiv.appendChild(newItem);
            itemCounter++;

            // Reseta a seleção e os campos de entrada
            $('#material-select').val(null).trigger('change');
            quantidadeInput.value = '';

            newItem.querySelector('.remove-item-btn').addEventListener('click', function() {
                newItem.remove();
                updateUI();
            });

            updateUI();
        });

        updateUI();
    });
</script>
{% endblock %}